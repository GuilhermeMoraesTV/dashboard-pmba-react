rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- 1. DEFINIÇÃO DE ADMIN ---
    function isAdmin() {
      return request.auth != null
        && request.auth.uid == "OLoJi457GQNE2eTSOcz9DAD6ppZ2";
    }

    // --- 2. BROADCASTS ---
    match /system_broadcasts/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // --- 3. EDITAIS/TEMPLATES ---
    match /editais_templates/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // --- 3.1 ACTIVE SESSIONS / ACTIVE TIMERS (✅ CORREÇÃO DO SEU ERRO) ---
    // Se o seu hook está lendo "active_sessions", precisa existir regra aqui.
    // Recomendo padronizar para "active_timers", mas deixei os dois liberados.

    match /active_sessions/{uid} {
      // Admin consegue ler todos os ativos
      allow read: if isAdmin();
      // Usuário pode criar/atualizar/apagar apenas o próprio doc
      allow create, update, delete: if request.auth != null && request.auth.uid == uid;
    }

    match /active_timers/{uid} {
      allow read: if isAdmin();
      allow create, update, delete: if request.auth != null && request.auth.uid == uid;
    }

    // --- 4. LEITURA GERAL PARA ADMIN ---
    // Registros de estudo em subcoleção: users/{uid}/registrosEstudo/{docId}
    match /{path=**}/registrosEstudo/{docId} {
      // Admin lê tudo
      allow read: if isAdmin();

      // Usuário lê só o que estiver no caminho dele (regra "users" abaixo já cobre),
      // mas deixo também uma proteção caso você use outras estruturas.
      allow read: if request.auth != null;

      // Se precisar deletar registros de outros usuários pelo painel:
      allow delete: if isAdmin();
    }

    match /{path=**}/ciclos/{docId} {
      allow read: if request.auth != null && (isAdmin() || true);
      // (mantive leitura liberada para logado, pois suas regras de users já restringem o resto)
    }

    // --- 5. REGRAS PADRÃO DE USUÁRIOS (Mantidas) ---
    match /users/{userId} {
      allow create: if request.auth != null;
      allow read, update, delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    match /users/{userId}/{document=**} {
      allow read, write, delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }

    // --- 6. BLOQUEIOS DE SEGURANÇA (LEGADO) ---
    match /horas/{docId} { allow read, write: if false; }
    match /metas/{docId} { allow read, write: if false; }
    match /questoes/{docId} { allow read, write: if false; }
  }
}
